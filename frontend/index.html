<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Task Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="login-container" class="container">
        <img src="assets/logo.png" alt="Nippon Express Logo"
            style="max-width: 250px; display: block; margin: 0 auto 1.5rem auto;">
        <h1>TMS System</h1>
        <p>Please login to manage shipments</p>
        <form id="login-form">
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="Enter your username" required>
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="save-btn">Login</button>
            <p id="login-error" class="msg error"></p>
        </form>
    </div>

    <div id="app-container" class="container" style="display: none;">
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <img src="assets/logo.png" alt="NX Logo" style="height: 40px;">
            </div>
            <div class="user-info">
                <span>Welcome, <strong id="display-username"></strong></span>
                <button id="logout-btn" class="logout-link">Log off</button>
            </div>
        </header>

        <nav class="app-nav">
            <button id="nav-dashboard" class="nav-btn" style="display: none;">Dashboard</button>
            <button id="nav-shipments" class="nav-btn active">Shipments</button>
            <button id="nav-milkrun" class="nav-btn">Milk Run</button>
            <button id="nav-trucks" class="nav-btn" style="display: none;">Trucks</button>
            <button id="nav-profile" class="nav-btn">Profile</button>
            <button id="nav-admin" class="nav-btn" style="display: none;">Admin</button>
        </nav>

        <main id="dashboard-view" style="display: none;">
            <div class="view-header">
                <h2>Operations Dashboard</h2>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Total Shipments</div>
                    <div class="kpi-value" id="kpi-total-shipments">-</div>
                </div>
                <!-- Volume -->
                <div class="kpi-card">
                    <div class="kpi-label">Total Volume</div>
                    <div class="kpi-value" id="kpi-total-volume">-</div>
                    <div class="kpi-sub">m¬≥</div>
                </div>
                <!-- Weight -->
                <div class="kpi-card">
                    <div class="kpi-label">Total Weight</div>
                    <div class="kpi-value" id="kpi-total-weight">-</div>
                    <div class="kpi-sub">kg</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-label">Active Trucks</div>
                    <div class="kpi-value" id="kpi-active-trucks">-</div>
                    <div class="kpi-sub" id="kpi-total-trucks">of - total trucks</div>
                </div>
                <div class="kpi-card" style="border-top: 3px solid var(--accent);">
                    <div class="kpi-label">In Transit</div>
                    <div class="kpi-value" id="kpi-in-transit">-</div>
                </div>
                <div class="kpi-card" style="border-top: 3px solid var(--success);">
                    <div class="kpi-label">Delivered</div>
                    <div class="kpi-value" id="kpi-delivered">-</div>
                </div>
            </div>

            <div class="chart-container"
                style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 2rem; margin-top: 2rem; height: 400px; display: flex; justify-content: center;">
                <canvas id="shipmentChart"></canvas>
            </div>

            <div class="chart-container"
                style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 2rem; margin-top: 2rem; height: 350px;">
                <h3 style="margin-bottom: 1rem; color: var(--text-muted); font-size: 1rem;">Shipment Activity (Last 30
                    Days)</h3>
                <canvas id="timelineChart"></canvas>
            </div>
        </main>

        <!-- Milk Run / Route Planner View -->
        <main id="milkrun-view" style="display: none; height: calc(100vh - 60px);">
            <div class="card" style="width: 100%; height: 100%; display: flex; flex-direction: column; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Milk Run Route Planner</h2>
                </div>

                <div style="display: flex; gap: 1rem; flex: 1; overflow: hidden; height: 100%;">
                    <!-- Sidebar: Stops -->
                    <div
                        style="width: 300px; display: flex; flex-direction: column; gap: 0.5rem; padding-right: 0.5rem; overflow: hidden;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem; margin-bottom: 0.2rem;">From Date</label>
                            <input type="date" id="mr-from-date" onchange="window.reloadMilkRunRoute()"
                                style="padding: 0.3rem; font-size: 0.85rem;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem; margin-bottom: 0.2rem;">To Date</label>
                            <input type="date" id="mr-to-date" onchange="window.reloadMilkRunRoute()"
                                style="padding: 0.3rem; font-size: 0.85rem;">
                        </div>

                        <div class="input-group" style="margin-bottom: 0.5rem;">
                            <label style="font-size: 0.8rem; margin-bottom: 0.2rem;">Select Truck</label>
                            <select id="routeTruckSelect" onchange="window.loadRouteForTruck(this.value)"
                                style="padding: 0.4rem; background: var(--glass); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;">
                                <option value="">-- Select Truck --</option>
                            </select>
                        </div>

                        <div id="routeStopList"
                            style="display: flex; flex-direction: column; gap: 0.5rem; overflow-y: auto; flex: 1; border-top: 1px solid var(--border); padding-top: 0.5rem;">
                            <p class="msg info">Select a truck to view its route.</p>
                        </div>
                    </div>

                    <!-- Main Map -->
                    <div
                        style="flex: 1; border-radius: 12px; border: 1px solid var(--border); position: relative; overflow: hidden;">
                        <div id="milkRunMap" style="width: 100%; height: 100%; border-radius: 12px;"></div>
                    </div>
                </div>
            </div>
        </main>

        <main id="shipments-view" style="display: none;">
            <!-- Create View -->
            <section class="shipment-input" style="display: none;">
                <div class="card" style="max-width: 800px;">
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                        <button onclick="window.toggleShipmentView('list')" class="btn-secondary">&larr; Back</button>
                        <h3 style="margin: 0;">Create New Shipment</h3>
                    </div>
                    <form id="shipment-form">
                        <!-- Part 1: General Info -->
                        <h4>General Info</h4>
                        <div class="input-grid">
                            <input type="text" id="cargoName" placeholder="Cargo Name" required>
                            <input type="text" id="description" placeholder="Description/Notes">
                        </div>

                        <!-- Part 2: Cargo Items (Moved before routes) -->
                        <h4 style="margin-top: 1rem;">Cargo Items</h4>
                        <div class="sub-card"
                            style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 16px; border: 1px dashed var(--border);">
                            <div class="input-grid"
                                style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label
                                        style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">Type</label>
                                    <select id="itemType" style="width: 100%;">
                                        <option value="Pallet">Pallet</option>
                                        <option value="Box">Box</option>
                                        <option value="Crate">Crate</option>
                                        <option value="Drum">Drum</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">Quantity</label>
                                    <input type="number" id="itemQty" placeholder="Qty" value="1" style="width: 100%;">
                                </div>
                            </div>
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">Volume
                                (m¬≥) & Weight (kg)</label>
                            <div class="input-grid"
                                style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <input type="number" id="itemVolume" placeholder="Volume (m¬≥)" step="0.001"
                                    style="text-align: center;">
                                <input type="number" id="itemWeight" placeholder="Weight (kg)"
                                    style="text-align: center;">
                            </div>
                            <button type="button" id="addItemBtn" class="add-btn" style="width: 100%;">+ Add
                                Item</button>
                        </div>
                        <div id="cargoItemsList"
                            style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;"></div>

                        <!-- Aggregates (Read Only) -->
                        <div class="input-grid" style="margin-top: 0.5rem;">
                            <div>Total Weight (kg)<input type="number" id="totalWeight" readonly
                                    style="background: transparent; border: none; font-weight: bold; color: var(--accent);">
                            </div>
                            <div>Total Volume (m¬≥)<input type="number" id="totalVolume" readonly
                                    style="background: transparent; border: none; font-weight: bold; color: var(--accent);">
                            </div>
                            <div>Pallets<input type="number" id="totalPallets" readonly
                                    style="background: transparent; border: none;"></div>
                            <div>Boxes<input type="number" id="totalBoxes" readonly
                                    style="background: transparent; border: none;"></div>
                        </div>

                        <!-- Part 3: Pickup Location -->
                        <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Pickup Location</h4>
                        <div class="sub-card"
                            style="background: rgba(0,177,64,0.1); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--success);">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--success); font-weight: 600;">üì¶
                                PICKUP ADDRESS</label>
                            <input type="text" id="origin" placeholder="Pickup Address" required
                                style="margin-bottom: 0.5rem;">
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="number" id="originLat" placeholder="Latitude" step="any" readonly
                                    style="background: rgba(0,0,0,0.2);">
                                <input type="number" id="originLng" placeholder="Longitude" step="any" readonly
                                    style="background: rgba(0,0,0,0.2);">
                                <button type="button" class="btn-secondary" onclick="window.openMapPicker('origin')"
                                    style="white-space: nowrap;">üìç Map</button>
                            </div>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="text" id="shipperName" placeholder="Shipper Name">
                                <input type="text" id="shipperPhone" placeholder="Shipper Phone">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-muted);">Pickup Date/Time</label>
                                <input type="datetime-local" id="pickupTime" style="width: 100%; color-scheme: dark;">
                            </div>
                        </div>

                        <!-- Part 4: Delivery Points -->
                        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Delivery Points</h4>
                        <div class="sub-card"
                            style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 16px; border: 1px dashed var(--border);">
                            <div id="deliveryPointsList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            </div>
                            <button type="button" onclick="window.addDeliveryPoint()" class="add-btn"
                                style="width: 100%; margin-top: 1rem;">+ Add Delivery Point</button>
                            <div id="quantitySummary"
                                style="margin-top: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 8px; display: none;">
                            </div>
                        </div>

                        <!-- General Remarks -->
                        <div style="margin-top: 1rem;">
                            <label style="font-size: 0.8rem; color: var(--text-muted);">Delivery Remarks
                                (Optional)</label>
                            <textarea id="deliveryRemark" placeholder="General remarks for this shipment..."
                                style="width: 100%; margin-top: 0.25rem; padding: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 8px;"></textarea>
                        </div>

                        <button type="submit" class="save-btn" style="width: 100%; margin-top: 1rem;">Create
                            Shipment</button>
                    </form>
                </div>
            </section>

            <!-- List View -->
            <section class="shipment-list-container">
                <div class="view-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>All Shipments</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <label style="color: var(--text-muted); font-size: 0.9rem; margin-right: 0.2rem;">Create
                            Date</label>
                        <input type="date" id="filter-date-from" title="From Date"
                            style="padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--glass); color: var(--text);">
                        <span style="color: var(--text-muted);">-</span>
                        <input type="date" id="filter-date-to" title="To Date"
                            style="padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--glass); color: var(--text);">
                        <button id="btn-create-shipment" onclick="window.toggleShipmentView('create')" class="save-btn"
                            style="width: auto;">+ Create New Shipment</button>
                    </div>
                </div>
                <!-- Search/Filter could go here -->
                <div id="shipmentList" class="shipment-list"></div>
            </section>
        </main>

        <main id="trucks-view" style="display: none;">
            <div class="admin-header" style="margin-bottom: 2rem;">
                <h1>Truck Management</h1>
            </div>

            <!-- Truck List Section -->
            <section id="truck-list-section">
                <div class="view-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Fleet Overview</h2>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="window.toggleTruckView('create')" class="save-btn" style="width: auto;">+
                            Register New Truck</button>
                    </div>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table id="truckTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>License Plate</th>
                                    <th>Model</th>
                                    <th>Capacity</th>
                                    <th>Status</th>
                                    <th>Driver</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="truckListBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Truck Form Section (Create/Edit) -->
            <section id="truck-form-section" style="display: none;">
                <div class="view-header"
                    style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 1rem;">
                    <button onclick="window.toggleTruckView('list')" class="btn-secondary" style="margin-right: 1rem;">‚Üê
                        Back</button>
                    <h3 id="truck-form-title">Register New Truck</h3>
                </div>
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <form id="truck-form">
                        <!-- Basic Info -->
                        <h4 style="color: var(--text-muted); margin-bottom: 0.5rem;">Basic Information</h4>
                        <div class="input-grid" style="margin-bottom: 1.5rem;">
                            <input type="text" id="licensePlate" placeholder="License Plate *" required>
                            <input type="text" id="truckModel" placeholder="Model *" required>
                            <input type="number" id="truckCapacity" placeholder="Capacity (kg)" step="0.1">
                            <select id="truckType"
                                style="padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--glass); color: var(--text);">
                                <option value="">Select Truck Type</option>
                                <option value="Box Truck">Box Truck</option>
                                <option value="Flatbed">Flatbed</option>
                                <option value="Refrigerated">Refrigerated</option>
                                <option value="Tanker">Tanker</option>
                                <option value="Container">Container</option>
                                <option value="Pickup">Pickup</option>
                            </select>
                            <select id="fuelType"
                                style="padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--glass); color: var(--text);">
                                <option value="">Select Fuel Type</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Electric">Electric</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="CNG">CNG</option>
                            </select>
                            <input type="number" id="truckYear" placeholder="Year (e.g. 2023)" min="1990" max="2030">
                            <input type="text" id="truckVin" placeholder="VIN (Vehicle ID Number)">
                            <input type="number" id="truckMileage" placeholder="Mileage (km)" min="0">
                            <select id="containerSize"
                                style="padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--glass); color: var(--text);">
                                <option value="">Select Container Size</option>
                                <option value="20ft">20ft</option>
                                <option value="40ft">40ft</option>
                                <option value="45ft">45ft</option>
                                <option value="53ft">53ft</option>
                            </select>
                        </div>

                        <!-- Assignment -->
                        <h4 style="color: var(--text-muted); margin-bottom: 0.5rem;">Assignment</h4>
                        <div class="input-grid" style="margin-bottom: 1.5rem;">
                            <select id="truckDriver"
                                style="padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--glass); color: var(--text);">
                                <option value="">Select Driver (Optional)</option>
                            </select>
                        </div>

                        <!-- Compliance -->
                        <h4 style="color: var(--text-muted); margin-bottom: 0.5rem;">Compliance</h4>
                        <div class="input-grid" style="margin-bottom: 1.5rem;">
                            <div>
                                <label
                                    style="display: block; color: #aaa; font-size: 0.75rem; margin-bottom: 0.25rem;">Registration
                                    Expiry</label>
                                <input type="date" id="registrationExpiry" style="width: 100%;">
                            </div>
                            <div>
                                <label
                                    style="display: block; color: #aaa; font-size: 0.75rem; margin-bottom: 0.25rem;">Insurance
                                    Expiry</label>
                                <input type="date" id="insuranceExpiry" style="width: 100%;">
                            </div>
                        </div>

                        <!-- Notes -->
                        <h4 style="color: var(--text-muted); margin-bottom: 0.5rem;">Notes</h4>
                        <textarea id="truckNotes" placeholder="Additional notes..." rows="3"
                            style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--glass); color: var(--text); resize: vertical; margin-bottom: 1rem;"></textarea>

                        <button type="submit" class="save-btn" style="width: 100%;">Save Truck</button>
                        <p id="truck-msg" class="msg"></p>
                    </form>
                </div>
            </section>
        </main>


        <main id="profile-view" style="display: none;">
            <div class="card profile-card">
                <h2>User Profile</h2>
                <form id="profile-form">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" id="profile-username" disabled>
                    </div>
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="profile-name" placeholder="Enter your full name">
                    </div>
                    <div class="input-group">
                        <label>Email Address</label>
                        <input type="email" id="profile-email" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label>Current Role</label>
                        <input type="text" id="profile-role" disabled>
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                    <p id="profile-msg" class="msg"></p>
                </form>
            </div>
        </main>

        <main id="admin-management-view" style="display: none;">
            <div class="admin-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>User Management</h1>
                <button id="btn-go-to-create" class="save-btn" style="width: auto; padding: 0.75rem 1.5rem;">Create New
                    User</button>
            </div>

            <section class="admin-users">
                <div class="card">
                    <h3>Managed Users</h3>
                    <div class="table-container">
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="userListBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <main id="admin-create-view" style="display: none;">
            <div class="admin-header" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem;">
                <button id="btn-back-to-mgmt" class="btn-secondary" style="padding: 0.5rem 1rem;">&larr; Back</button>
                <h1>Create New User</h1>
            </div>

            <div class="card">
                <form id="create-user-form">
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Username</label>
                            <input type="text" id="new-username" placeholder="Username" required>
                        </div>
                        <div class="input-group">
                            <label>Password</label>
                            <input type="password" id="new-password" placeholder="Password" required>
                        </div>
                    </div>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Full Name</label>
                            <input type="text" id="new-fullname" placeholder="Full Name" required>
                        </div>
                        <div class="input-group">
                            <label>Email Address</label>
                            <input type="email" id="new-email" placeholder="Email Address" required>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Role</label>
                        <select id="new-role">
                            <option value="user">User</option>
                            <option value="driver">Driver</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <button type="submit" class="save-btn">Save New User</button>
                    <p id="create-user-msg" class="msg"></p>
                </form>
            </div>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal-overlay" style="display: none;">
        <div class="modal-content card">
            <h2>Edit User</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="input-group">
                    <label>Username (Read-only)</label>
                    <input type="text" id="edit-username" disabled>
                </div>
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-fullname" required>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="input-group">
                    <label>Role</label>
                    <select id="edit-role">
                        <option value="user">User</option>
                        <option value="driver">Driver</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="closeEditModal">Cancel</button>
                    <button type="submit" class="save-btn">Update User</button>
                </div>
            </form>
        </div>
    </div>




    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay" style="display: none;">
        <div class="modal-content card" style="max-width: 400px;">
            <h2>Change Password</h2>
            <form id="change-password-form">
                <input type="hidden" id="cp-user-id">
                <div class="input-group">
                    <label>New Password</label>
                    <input type="password" id="cp-new-password" placeholder="Enter new password" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="closeChangePasswordModal">Cancel</button>
                    <button type="submit" class="save-btn">Update Password</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Map Picker Modal -->
    <div id="mapModal" class="modal-overlay" style="display: none; z-index: 1000;">
        <div class="modal-content card"
            style="width: 90%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Select Location</h3>
                <button type="button" class="btn-secondary"
                    onclick="document.getElementById('mapModal').style.display='none'">Close</button>
            </div>
            <div id="leafletMap" style="flex: 1; border-radius: 8px;"></div>
            <p class="msg info" style="margin-top: 0.5rem;">Click on the map to select coordinates.</p>
        </div>
    </div>

    <!-- Shipment Details Modal -->
    <div id="detailsModal" class="modal-overlay" style="display: none; z-index: 1000;">
        <div class="modal-content card"
            style="width: 90%; max-width: 900px; height: 90vh; display: flex; flex-direction: column; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="detail-id">Shipment #00000</h2>
                <button type="button" class="btn-secondary"
                    onclick="document.getElementById('detailsModal').style.display='none'">Close</button>
            </div>

            <div id="detail-content" style="display: flex; flex-direction: column; gap: 1.5rem;">

                <!-- Manifest Info -->
                <div>
                    <div class="input-grid">
                        <div><strong>Cargo:</strong> <span id="d-cargo"></span></div>
                        <div><strong>Status:</strong> <span id="d-status"></span></div>
                    </div>

                    <!-- Dynamic Shipment Legs Section -->
                    <div style="margin-top: 1rem;">
                        <div
                            style="display:flex; justify-content:space-between; margin-bottom:1rem; align-items: center;">
                            <h4 style="margin:0;">Shipment Legs</h4>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size:0.8rem; opacity:0.7;">Created: <span
                                        id="d-created"></span></span>
                                <a id="btn-view-route-gmaps" href="#" target="_blank" class="btn-secondary"
                                    style="font-size: 0.75rem; padding: 0.3rem 0.6rem; text-decoration: none;">View
                                    Route in Google Maps ‚Üó</a>
                            </div>
                        </div>

                        <!-- Legs will be dynamically rendered here -->
                        <div id="d-legs-container" style="display: flex; flex-direction: column; gap: 1rem;"></div>
                    </div>

                    <!-- Proof of Delivery Section -->
                    <div id="d-pod-section"
                        style="margin-top: 1rem; background: rgba(0, 177, 64, 0.1); padding: 1rem; border-radius: 8px; display: none;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--success);">Proof of Delivery</h4>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div id="d-pod-sig-container" style="display: none;">
                                <label
                                    style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.3rem;">Receiver
                                    Signature</label>
                                <div
                                    style="background: white; padding: 5px; border-radius: 4px; display: inline-block;">
                                    <img id="d-pod-signature"
                                        style="max-width: 100%; max-height: 150px; display: block;" alt="Signature">
                                </div>
                            </div>
                            <div id="d-pod-img-container" style="display: none;">
                                <label
                                    style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.3rem;">Delivery
                                    Photo</label>
                                <img id="d-pod-image"
                                    style="max-width: 100%; border-radius: 4px; border: 1px solid var(--border);"
                                    alt="Proof of Delivery">
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-top: 1rem;">Cargo Items</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                        <thead style="background: rgba(255,255,255,0.1);">
                            <tr>
                                <th>Type</th>
                                <th>Vol (m¬≥)</th> <!-- Updated Header -->
                                <th>Wgt (kg)</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody id="d-items-body"></tbody>
                    </table>
                </div>

                <!-- Route Map -->
                <div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0;">Route Map</h4>
                        <a id="btn-open-gmaps" href="#" target="_blank" class="btn-secondary"
                            style="font-size: 0.8rem; padding: 0.4rem 0.8rem; text-decoration: none; display: flex; align-items: center; gap: 0.3rem;">
                            <span>Open in Google Maps</span> ‚Üó
                        </a>
                    </div>
                    <div id="routeMap"
                        style="width: 100%; height: 350px; border-radius: 12px; border: 1px solid var(--border);"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Proof of Delivery (ePOD) Modal -->
    <div id="podModal" class="modal-overlay" style="display: none;">
        <div class="modal-content card" style="max-width: 500px;">
            <h2>Proof of Delivery</h2>
            <p style="color: #888; margin-bottom: 1rem;">Please collect receiver signature and optional photo.</p>

            <div class="input-group">
                <label>Receiver Signature</label>
                <div style="background: white; padding: 5px; border-radius: 4px;">
                    <canvas id="signaturePad" width="400" height="200"
                        style="width: 100%; touch-action: none; cursor: crosshair;"></canvas>
                </div>
                <button type="button" id="clearSignature" class="btn-secondary"
                    style="margin-top: 5px; font-size: 0.8rem; padding: 0.3rem 0.8rem;">Clear Signature</button>
            </div>

            <div class="input-group">
                <label>Delivery Photo (Optional)</label>
                <input type="file" id="podImageInput" accept="image/*" capture="environment">
                <p id="imagePreviewText" style="font-size: 0.8rem; color: #888; margin-top: 5px;"></p>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="closePodModal">Cancel</button>
                <button type="button" id="confirmDeliveryBtn" class="save-btn">Confirm Delivery</button>
            </div>
        </div>
    </div>


    <script src="app.js"></script>
</body>

</html>